---
title: 'AD Knowledge Portal: Download and explore 5XFAD mouse data in Rstudio'
output:
  html_document:
    df_print: paged
---

### Setup

Install `synapser`, the [Synapse R client](https://r-docs.synapse.org/articles/synapser.html).
```{r}
install.packages("synapser", repos = c("http://ran.synapse.org", "http://cran.fhcrc.org"))
```

You may already have some or all of these packages installed, but if not, install these as well!

```{r}
install.packages("purrr")
install.packages("dplyr")
install.packages("ggplot2")
```

Next, you will need to log in to your Synapse account. In the code below, replace the <> with your Synapse username and password. 

```{r}
synapser::synLogin(username = "<username>", password = "<password>")
```

If you usually log in to Synapse with your Google account, you will need to use a Synapser Personal Access Token (PAT) to log in with the R client. Follow these instructions to [generate a personal access token](https://help.synapse.org/docs/Managing-Your-Account.2055405596.html#ManagingYourAccount-Loggingin), then paste the PAT into the code bewlow. *Note*: make sure you scope your access token to allow you to View, Download, and Modify 

```{r}
synapser::synLogin(authToken = "<paste your personal access token here>")
```


### Download data

Bulk download using an exported table of file synIDs and the R or Python client.

Once you've identified the files you want to download, click on the download arrow icon on the top right of the Explore Data table and select "Export Table" from the drop-down menu. For this example, choose to download the file as a csv. 

A file named `Job-#long-string-of-numbers#.csv` will download to your local environment. This file contains the file names, their synIDs, and all the file metadata and annotations associated with each file.

We'll use the R client to walk through the list of synID in the exported table using and download the associated file using `synGet()`. 

R:

```{r}
exported_table <- read.csv("Job-####.csv")
purrr::walk(exported_table$id, ~synapser::synGet(.x, downloadLocation = "files/"))
```

Read the downloaded files into R.
```{r}
#counts matrix
counts <- read.delim("files/tpm_gene_5XFAD.txt")

#individual metadata
ind_meta <- read.csv("files/Jax.IU.Pitt_5XFAD_individual_metadata.csv")

#biospecimen metadata
bio_meta <- read.csv("files/Jax.IU.Pitt_5XFAD_biospecimen_metadata.csv")

#assay metadata

```

Identify the individual specimens in the matrix, create an ID key to join the biospecimen IDs and individual IDs. The resulting metadata file will contain only the individuals in the matrix
```{r}
#first remove the leading X from the column names, which are the specimenIDs
colnames(counts) <- gsub("X","",colnames(counts))
#create a dataframe of the specimenIDs in the study from the counts matrix
specimenID <- as.data.frame(colnames(counts))
specimenID <- specimenID[-1,]
specimenID <- as.data.frame(specimenID)
names(specimenID)[names(specimenID) == "colnames(counts)"] <- "specimenID"
IDkey <- subset(bio_meta, select=c(individualID, specimenID))
#trim the IDkey down to include only those in the study:
IDkey <- dplyr::left_join(specimenID, IDkey, by="specimenID")
#the biospecimens metadata has both IDs needed to join the ind_meta and counts matrix
ind_meta2 <- dplyr::left_join(IDkey, ind_meta, by="individualID")
```
Add a column with simplified time points (4, 6, and 12 months).
```{r}
#take a look at time point designations:
table(ind_meta2$jobNumber)
```
#recode for 4, 6, 12 months
```{r}
ind_meta2$timepoint <- ifelse(ind_meta2$jobNumber=='JAX 5xFAD 12mo', '12mo',
                              ifelse(ind_meta2$jobNumber=='JAX DMP 5xFAD 6month', '6mo', '4mo'))
table(ind_meta2$sex, ind_meta2$timepoint)
```


Transform the ensemblIDs in the matrix to common gene names, using the R package biomaRt (note: must use mouse database, though two genes in the 5XFAD are humanized and won't be translated by the program)
```{r}
#functions to convert ensemblIDs to gene names
convertEnsemblToHgnc <- function(ensemblIds){
  
  ensembl=biomaRt::useMart('ENSEMBL_MART_ENSEMBL',
                           dataset = 'mmusculus_gene_ensembl',
                           host='useast.ensembl.org')
  
  genes<-getBM(attributes = c('ensembl_gene_id','external_gene_name'),
               filters='ensembl_gene_id',
               values=ensemblIds,
               mart=ensembl)
  return(genes)
}
Make.Gene.Symb <- function(GeneENSG){
  
  #source('convertEnsemblToHgnc.R')
  GeneConv <- convertEnsemblToHgnc(GeneENSG)
  Symb <- as.character(c(1:length(GeneENSG)))
  
  for (i in 1:length(GeneENSG)){
    In <- which(GeneConv$ensembl_gene_id == GeneENSG[i])
    if (length(In)>0){
      Symb[i] <- GeneConv$external_gene_name[In]
    }
  }
  
  return(Symb)
  
}
#call the functions and add a new column
counts$gene_short_name <- Make.Gene.Symb(counts$gene_id)
```
Need to clean up the gene names a little, and assign them as row names
```{r}
#The first two genes in the matrix are the humanized genes PSEN1 (ENSG00000080815) and APP (	ENSG00000142192). Set these manually:
counts[1, "gene_short_name"] <- "PSEN1"
counts[2, "gene_short_name"] <- "APP"

#make all gene names unique and assign them as row names:
counts$gene_short_name <- make.unique(counts$gene_short_name)
rownames(counts) <- counts$gene_short_name

#delete unnecessary columns
counts$gene_id<-NULL
counts$gene_short_name<-NULL


#transpose the matrix, so genes are columns and individuals are rows
counts2 <- as.data.frame(t(counts))
#add back a specimenID column to the matrix and join the metadata to the entire data frame:
counts2$specimenID <- row.names(counts2)
counts2 <- dplyr::left_join(counts2, ind_meta2, by="specimenID")
View(counts2)
```

Create simple box plots showing normalized counts by genotype and time point, faceted by sex
```{r}
library(ggplot2)

#re-order time points
counts2$timepoint <- factor(counts2$timepoint, levels=c("4mo","6mo","12mo"))

#Look at Trem2 levels
g <- ggplot(counts2, aes(x=timepoint, y=Trem2, color=genotype))
g <- g + geom_boxplot() + geom_point(position=position_jitterdodge())
g <- g + facet_wrap(~sex)
g
```

Examine any gene of interest by calling it
```{r}
g <- ggplot(counts2, aes(x=timepoint, y=Cst7, color=genotype))
g <- g + geom_boxplot() + geom_point(position=position_jitterdodge())
g <- g + facet_wrap(~sex)
g
```


```{r}
g <- ggplot(counts2, aes(x=timepoint, y=Apoe, color=genotype))
g <- g + geom_boxplot() + geom_point(position=position_jitterdodge())
g <- g + facet_wrap(~sex)
g
```
```{r}
g <- ggplot(counts2, aes(x=timepoint, y=Kirrel2, color=genotype))
g <- g + geom_boxplot() + geom_point(position=position_jitterdodge())
g <- g + facet_wrap(~sex)
g
```


```{r}
```


```{r}
```

